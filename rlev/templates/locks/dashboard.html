<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <link rel="icon" href="/dashboard/media/logo.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>ניהול הרשאות אורחים</title>
    <style>
        .toast {
            animation: slideIn 0.5s ease-in-out;
            position: fixed;
            top: 90%;
        }

        .main-content {
            display: flex;
            overflow: hidden;
            height: calc(100vh - 65px);
        }

        .side-menu {
            flex: 0 0 250px;
            overflow-y: auto;
        }

        .content {
            flex: 1;
            overflow-y: auto;

        }

        .custom-shadow {
            transition: box-shadow 0.6s ease;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        }

        .custom-shadow:hover .hover-shadow:hover {
            box-shadow: 0 0 9px rgba(0, 0, 0, 0.3);
        }

        .dimmed {
            z-index: 1040;
        }

        #modal-md {
            z-index: 1800;
        }

        #locks_modal {
            z-index: 1900;
        }

        #houses_modal {
            z-index: 1900;
        }


        .modal-header {
            border-bottom: none;
        }

        .selected {
            background-color: #cfe2ff
        }

        .identification_selected {
            background-color: #cfe2ff
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .ui-autocomplete {
            z-index: 3000 !important;
        }

        .locks-alerts {
            position: absolute;
            bottom: 0;
            left: calc(100% - 240px);
            right: 10px;
            max-height: 100%;
            overflow-y: auto;
            background-color: var(--bs-danger-bg-subtle);

            padding: 10px;
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
        }
    </style>
</head>

<body class="h-100">
    <div class="toast fixed-top p-1 text-bg-success" style="z-index: 2000" id="toast-message" role="alert"
        aria-live="assertive" aria-atomic="true" data-delay="3000"></div>
    <nav class="navbar navbar-fixed-top navbar-light bg-light shadow p-2" style="z-index: 1010">
        <span class="navbar-brand p-2">רחשי לב - ניהול הרשאות אורחים</span>
        <ul class="nav">
            <li class="nav-item p-2 cursor-pointer">
                <span class="badge text-bg-danger d-none" id="WebSocket_status"><i class="bi bi-exclamation-circle"></i>
                    סנכרון זמן אמת לא פעיל</span>
            </li>
            <li class="nav-item">
                <span class="nav-link">{{ user.first_name }} {{ user.last_name }}</span>
            </li>
            <li class="nav-item">
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger">התנתק</button>
                </form>
            </li>
        </ul>
    </nav>
    <div class="container-fluid p-0">
        <div class="main-content">
            <nav class="d-block bg-light side-menu sidebar shadow p-2" style="z-index: 1008">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        {% if user.allow_main or is_admin %}
                        <li id="persons_button" class="nav-item">
                            <a class="nav-link " href="#" data-page="persons">
                                <i class="bi bi-people"></i> אנשי קשר
                            </a>
                        </li>
                        {% if user.allow_houses or is_admin %}
                        <li id="houses_button" class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="houses">
                                <i class="bi bi-houses"></i> דירות
                            </a>
                        </li>
                        {% if user.allow_hostings or is_admin %}
                        <li class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="hostings">
                                <i class="bi bi-suitcase2"></i> אירוחים
                            </a>
                        </li>
                        {% endif %}
                        {% endif %}
                        {% if user.allow_hostings_ichilov or is_admin %}
                        <li class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="hostings_ichilov">
                                <i class="bi bi-suitcase2"></i> אירוחים - איכילוב
                            </a>
                        </li>
                        {% endif %}
                        <li id="locks_button" class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="locks">
                                <i class="bi bi-lock"></i> מנעולים
                            </a>
                        </li>
                        {% if user.allow_permissions or is_admin %}
                        <li id="locks_button" class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="permissions">
                                <i class="bi bi-shield"></i> הרשאות
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="passages">
                                <i class="bi bi-clock-history"></i> מצבי מעבר
                            </a>
                        </li>
                        {% endif %}
                        {% if user.allow_locks_records or is_admin %}
                        <li class="nav-item">
                            <a id="records_tab_main" class="nav-link text-secondary" href="#" data-page="records">
                                <i class="bi bi-calendar2-check"></i> רשומות נעילה
                            </a>
                        </li>
                        {% endif %}
                        {% if user.allow_main or is_admin %}
                        <li class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="transmissions">
                                <i class="bi bi-wifi"></i> שידורי הרשאות
                                <span id="amount_in_transmission"
                                    class="badge rounded-pill text-bg-secondary cursor-pointer {% if not amount_in_transmission %} d-none {% endif %}">
                                    {{amount_in_transmission}}
                                </span>
                            </a>
                        </li>
                        {% endif %}
                        {% if is_admin %}
                        <li class="nav-item">
                            <a class="nav-link text-secondary" href="#" data-page="users">
                                <i class="bi bi-person-check"></i> ניהול משתמשים
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% if alert_locks %}
                <div class="locks-alerts text-center">
                    <span class="badge text-bg-warning row">התראת מנעולים </span><br>
                    {% for lock in alert_locks %}
                    {{ lock.lock_alias }} <span class="text-danger"> <i class="bi bi-battery"></i>
                        {{ lock.electric_quantity}}%</span><br>
                    {% endfor %}
                </div>
                {% endif %}
            </nav>
            <div id="content" class="content "></div>
        </div>
    </div>
    <div class="modal fade modal-lg" id="modal-lg" tabindex="-1">
        <div class="modal-dialog">
            <div id="lg-modal-content" class="modal-content"></div>
        </div>
    </div>

    <div class="modal fade modal-xl" id="modal-xl" tabindex="-1">
        <div class="modal-dialog">
            <div id="xl-modal-content" class="modal-content"></div>
        </div>
    </div>

    <div class="modal fade modal-md" id="modal-md" tabindex="-1">
        <div class="modal-dialog">
            <div id="md-modal-content" class="modal-content"></div>
        </div>
    </div>

    <div class="modal fade modal-md" id="hosting_modal" tabindex="-1">
        <div class="modal-dialog">
            <div id="hosting_modal_content" class="modal-content"></div>
        </div>
    </div>

    <div class="locks-modal modal-xl fade modal rounded" id="locks_modal">
        <div class="modal-dialog">
            <div id="locks_modal_content" class="modal-content">


            </div>
        </div>

    </div>

    <div class="houses-modal modal-xl fade modal rounded" id="houses_modal">
        <div class="modal-dialog">
            <div id="houses_modal_content" class="modal-content">


            </div>
        </div>

    </div>

    <div class="modal fade" id="modal-cls" tabindex="-1">
        <div class="modal-dialog">
            <div id="cls-modal-content" class="modal-content"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade confirmation-modal" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">אישור</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="confirmationText"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancel" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" id="confirmation" class="btn btn-primary">אישור</button>
                </div>
            </div>
        </div>
    </div>
    <!---->
    <iframe id="pdf-frame" style="display: none;"></iframe>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script>
    const person_fields = ['first_name', 'last_name', 'phone', 'email', 'address', 'house_number', 'city'];
    $(document).ready(function () {
        var csrfToken = "{{ csrf_token }}";

        if ($("#persons_button").length) {
            loadContent('#content', 'persons');
        }
        else {
            loadContent('#content', 'hostings_ichilov');
        }

        $('.sidebar a').click(function (e) {
            e.preventDefault();
            var page = $(this).data('page');
            loadContent('#content', page);
            $('.sidebar a').addClass('text-secondary');
            $(this).removeClass('text-secondary');
        });


        $('.modal-lg, .modal-md, .modal-xl').on('hidden.bs.modal', function () {
            $(this).find('.modal-content').html('');
        });

        $('.modal-md').on('show.bs.modal', function () {
            $('#modal-lg').addClass('dimmed');
        });

        $('#modal-md').on('show.bs.modal', function () {
            $('#hosting_modal').addClass('dimmed');
        });

        $('#modal-xl').on('show.bs.modal', function () {
            $('#modal-lg').addClass('dimmed');
        });


        $('.modal-md').on('hidden.bs.modal', function () {
            $('#modal-xl, #hosting_modal, #modal-lg').removeClass('dimmed');
            if ($('#hosting_modal').hasClass('show')) $('#modal-lg').addClass('dimmed');
        });

        $('.modal-xl').on('hidden.bs.modal', function () {
            $('#modal-md, #modal-lg').removeClass('dimmed');
            if ($('#modal-md').hasClass('show')) $('#modal-lg').addClass('dimmed');
        });

        $("#hosting_modal").on('hidden.bs.modal', function () {
            $('#modal-lg, #modal-md').removeClass('dimmed');
            $('#hosting_modal_content').empty();
            $(this).removeClass('modal-xl').addClass('modal-md');
        });

        $('.confirmation-modal').on('hidden.bs.modal', function () {
            $('#modal-lg, #modal-md, #modal-xl, #hosting_modal').removeClass('dimmed');
            if ($('.modal-md').hasClass('show')) $('#modal-lg').addClass('dimmed');
        });


        $('.confirmation-modal').on('show.bs.modal', function () {
            $('#modal-lg, #modal-md, #modal-xl, #hosting_modal').addClass('dimmed');
        });

        $('.locks-modal').on('hidden.bs.modal', function () {
            $('#locks_modal_content').empty();
        });

        $(document).on('click', '.pages-btn', function () {
            let modelName = $(this).parent().data('model-name');
            let page = $(this).text();
            $(`.${modelName}-pages .page-number`).val(page);
            getTable(modelName);
        });

        $(document).on('change', '.page-input', function () {
            let modelName = $(this).parent().data('model-name');
            getTable(modelName);
        });

        $(document).on('change', '.filter-control', function () {

            let modelName = $(this).closest('[data-model-name]').data('model-name');
            getTable(modelName);
        });

        $(document).on('click', '.column-sort', setSortColumn);

        let timeoutID;

        function redirect() {
            window.location.href = 'http://childrens-house.r-lev.org/login/';
        }

        function resetTimeout() {
            clearTimeout(timeoutID);
            timeoutID = setTimeout(redirect, 1800000);
        }

        timeoutID = setTimeout(redirect, 1800000);
        $(document).on('click mousemove keydown scroll', resetTimeout);

    });

    function setSortColumn() {
        // קבל את האייקון של העמודה הנלחצת
        const icon = $(this).find('.sort-icon');
        let currentSort = icon.attr('data-sort');

        $(this).closest('table').find('th').find('.sort-icon').removeClass('d-inline').addClass('d-none')
            .removeClass('bi-caret-down-fill bi-caret-up-fill')
            .attr('data-sort', 'none');

        // קבע את מצב המיון הבא
        let newSort;
        if (currentSort === 'none' || currentSort === 'desc') {
            newSort = 'asc';
            icon.removeClass('bi-caret-up-fill').addClass('bi-caret-down-fill');
        } else {
            newSort = 'desc';
            icon.removeClass('bi-caret-down-fill').addClass('bi-caret-up-fill');
        }
        // עדכן את ה־data-sort ואפשר את האייקון
        icon.attr('data-sort', newSort).removeClass('d-none').addClass('d-inline');
        let modelName = $(this).closest('table').data('model-name');
        getTable(modelName);
    }

    function refresh_persons_windows() {
        if (($("#persons_container").length)) {
            load_persons();
        }

    }

    function refresh_passages_screen() {
        if ($('#passages').length) {
            loadContent('#content', 'passages', false);
        }
        if ($('#passage_locks_list').length) {
            get_locks_passage_list();
        }
    }

    function refresh_houses_windows() {
        if ($('#houses_win').length) {
            loadContent('#content', 'houses', false);
        }

    }

    function refresh_hostings_windows() {
        if ($("#house_table_hostings").length) {
            get_house_list_child('hostings', false);
        }
        if ($('#houses_win').length) {
            loadContent('#content', 'houses', false);
        }
        if ($('#hsotings_win').length) {
            loadContent('#content', 'hostings', false);
        }
        if ($("#person_table_hostings").length) {
            get_person_list_child('hostings', false);
        }
    }

    function autocomplete(element, data) {
        $(element).autocomplete({
            source: data,
            minLength: 0
        });
        $(element).on('focus', function () {
            $(element).autocomplete("search", $(element).val());
        });
    }



    function loadContent(element, page, set_empty = true, callback = null) {
        var element = $(element);
        if (set_empty) {
            element.empty();
            element.append('<div class="d-flex justify-content-center h-100"><div class="d-flex justify-content-center align-items-center"><div class="spinner-border" role="status"></div></div></div>');
        }

        element.load(page, function (response, status, xhr) {
            if (status === "error") {
                if (xhr.status === 401) {
                    window.location.href = '/login';
                } else {
                    console.error('Error loading content:', xhr.status, xhr.statusText);
                }
            }
            else {
                if (typeof callback === "function") {
                    callback();
                }
            }
        });
    }

    function confirmation_modal(text) {
        $('#confirmationText').html(text);
        return new Promise((resolve, reject) => {
            $("#confirmationModal").modal('show');

            $("#confirmation").on("click", function () {
                $("#confirmationModal").modal('hide');
                resolve();
            });
            $("#cancel").removeClass('d-none');
            $("#cancel").on("click", function () {
                $("#confirmationModal").modal('hide');
                reject();
            });
        });
    }

    function simple_message_modal(text) {
        $('#confirmationText').html(text);
        $("#cancel").addClass('d-none');
        $("#confirmationModal").modal('show');
        $("#confirmation").on("click", function () {
            $("#confirmationModal").modal('hide');
        });
    }

    function select_locks() {
        return new Promise((resolve, reject) => {
            loadContent('#locks_modal_content', 'select_locks', true, function () {

                $('#locks_modal').modal('show');

                $("#select_locks").off("click").on("click", function () {
                    const locks_ids = $('.card-select-lock.selected').map(function () {
                        return $(this).data('lock-id');
                    }).get();
                    const locks_descriptions = $('.card-select-lock.selected').map(function () {
                        return $(this).find('.card-body').text();
                    }).get();
                    $("#locks_modal").modal('hide');

                    resolve({ locks_ids: locks_ids, locks_descriptions: locks_descriptions });
                });

                $("#cancel_select_locks").off("click").on("click", function () {
                    $("#locks_modal").modal('hide');
                    reject('User canceled the selection');
                });
            });
        });
    }

    function select_houses() {
        return new Promise((resolve, reject) => {
            loadContent('#houses_modal_content', 'select_houses', true, function () {

                $('#houses_modal').modal('show');

                $("#select_houses").off("click").on("click", function () {
                    const houses_ids = $('.card-select-house.selected').map(function () {
                        return $(this).data('house-id');
                    }).get();
                    const houses_descriptions = $('.card-select-house.selected').map(function () {
                        return $(this).find('.card-body').text();
                    }).get();
                    $("#houses_modal").modal('hide');

                    resolve({ houses_ids: houses_ids, houses_descriptions: houses_descriptions });
                });

                $("#cancel_select_houses").off("click").on("click", function () {
                    $("#houses_modal").modal('hide');
                    reject('User canceled the selection');
                });
            });
        });
    }

    function sort_table() {

        const columnName = $(this).data('column-name');
        const tableBody = $('table tbody');
        const rows = tableBody.find('tr').get();

        rows.sort(function (a, b) {
            let keyA = $(a).find('td[data-column-name="' + columnName + '"]').text();
            let keyB = $(b).find('td[data-column-name="' + columnName + '"]').text();

            if (columnName === 'lodging_start_formater' || columnName === 'lodging_end_formater') {
                let [dayA, monthA, yearA] = keyA.split('/');
                let formattedDateStrA = `${yearA}-${monthA}-${dayA}`;

                let [dayB, monthB, yearB] = keyB.split('/');
                let formattedDateStrB = `${yearB}-${monthB}-${dayB}`;

                return ascending ? new Date(formattedDateStrA) - new Date(formattedDateStrB) : new Date(formattedDateStrB) - new Date(formattedDateStrA);
            } else {
                return ascending ? keyA.localeCompare(keyB) : keyB.localeCompare(keyA);
            }
        });

        $.each(rows, function (index, row) {
            tableBody.append(row);
        });
        ascending = !ascending;
    }

    function alert_message(text, type) {

        $('#toast-message').removeClass('text-bg-success text-bg-danger');
        if (type === 'ok') {
            var symbol = '<i class="bi bi-check-circle"></i>';
            var classType = 'text-bg-success';
        }
        if (type === 'error') {
            var symbol = '<i class="bi bi-x-circle"></i>';
            var classType = 'text-bg-danger';
        }
        $('#toast-message').html(symbol + '  ' + text).addClass(classType);
        $('#toast-message').toast('show')
    }

    async function transmission(locks) {
        if (locks.length == 0) return;
        refresh_permissions_screens();

        $.ajax({
            url: 'transmission',
            type: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: {
                'locks[]': locks
            },
            dataType: 'json',
            error: function (xhr, textStatus, errorThrown) {
                if (xhr.status === 401) {
                    window.location.href = '/login';
                }
            }
        });
    }

    function refresh_permissions_screens() {

        if ($('#lock_table_permissions').length) {
            get_lock_list_child('permissions', false);
        }
        if ($('#person_modal').length) {
            check_view_permissions();
        }
        if ($('#person_table_permissions').length) {
            get_person_list_child('permissions', false);
        }
        if ($('#person_table_cards').length) {
            get_person_list_child('cards', false);
        }
        if ($('#transmission_table').length) {
            load_transmission_data();
        }
    }

    function refresh_locks_screen() {
        if ($('#locks_header').length) {
            loadContent('#content', 'locks', false);
        }
    }

    // const socket = new WebSocket(
    //     'wss://'
    //     + window.location.host
    //     + '/ws/messages'
    //     + '/'
    // );

    // socket.onopen = function () {
    //     console.log('WebSocket open');
    // }

    // socket.onerror = function (error) {
    //     console.log('WebSocket error:', error);
    //     $("#WebSocket_status").removeClass('d-none');
    // }

    // socket.onmessage = function (e) {

    //     const data = JSON.parse(e.data);
    //     do_event(data);
    // };

    // socket.onclose = function (e) {
    //     $("#WebSocket_status").removeClass('d-none');
    // };


</script>

<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<script>

    //   Pusher.logToConsole = true;

    var pusher = new Pusher('2e4260e6830134379df9', {
        cluster: 'ap2'
    });

    var channel = pusher.subscribe('messages');
    channel.bind('get_message', function (message) {
        do_event(message);
    });

    function do_event(message) {
        // console.log(message)
        var type = message.type;
        switch (type) {
            case 'start_transmission':
            case 'end_transmission':
            case 'refresh_permissions_screens':
            case 'end_sync':
                refresh_permissions_screens();
                break;
            case 'start_transmissions':
                $('#amount_in_transmission').removeClass('d-none');
                $('#amount_in_transmission').removeClass('text-bg-secondary');
                $('#amount_in_transmission').addClass('text-bg-warning');
                break;
            case 'end_transmissions':
                $('#amount_in_transmission').addClass('text-bg-secondary');
                $('#amount_in_transmission').removeClass('text-bg-warning');
                refresh_permissions_screens();
                break;
            case 'start_main_sync':
                alert_message("סנכרון ראשי התחיל", 'ok');
                break;
            case 'end_main_sync':
                alert_message("סנכרון ראשי הסתיים", 'ok');
                refresh_locks_screen();
                break;
            case 'refresh_locks':
                refresh_locks_screen();
                break;
            case 'refresh_records':
                if ($("#recordsTable").length) {
                    loadContent('#content', 'records', false);
                }
                break;
            case 'error_lock_not_active':
                alert_message("שגיאת חוסר הרשאה למנעול", 'error');
                refresh_locks_screen();
                break;
            case 'amount_in_transmission':
                var amount = message.data
                if (amount == 0) {
                    $('#amount_in_transmission').addClass('d-none');
                }
                else {
                    $('#amount_in_transmission').text(amount);
                }
                break;
            case 'change_lock_passage':
                refresh_passages_screen();
                break;
        }
    }

</script>


<script>
    var models = {
        permission: {
            itemDescription: 'הרשאה',
            itemsDescription: 'הרשאות',
            successMessage: 'ההרשאה נשמרה בהצלחה',
            deleteMessage: 'ההרשאה נמחקה בהצלחה',
            typeTable: 'pages',
            specialObjects: 'cards_objects'
        },
        hosting: {
            itemDescription: 'אירוח',
            itemsDescription: 'אירוחים',
            successMessage: 'האירוח נשמר בהצלחה',
            deleteMessage: 'האירוח נמחק בהצלחה',
            typeTable: 'pages',
            specialObjects: 'hostings_objects'
        }
    };


    function getTable(modelName) {
        let modelTable = $('table[data-model-name="' + modelName + '"]');
        if (modelTable.length > 0) {
            var typeTable = models[modelName]?.typeTable ?? 'standart';
            if (typeTable === 'standart') getStandartTable(modelName, modelTable);
            if (typeTable === 'pages') getPagesTable(modelName);

        }
    }

    function getStandartTable(modelName) {
        let modelTable = $('table[data-model-name="' + modelName + '"]');
        $.ajax({
            url: '/data_manager/table/' + modelName,
            method: 'GET',
            dataType: 'html',
            success: function (html) {
                modelTable.find('tbody').html(html);
                modelTable.find('tbody tr').click(viewItemModal);
                runOptionalFunction(`${modelName}sFilter`);
            }
        });
    }

    function getPagesTable(modelName) {
        let modelTable = $('table[data-model-name="' + modelName + '"]');

        let filters = getFiltersOfModel(modelName);
        let sort = getSortOfModel(modelName);
        let page = $(`.${modelName}-pages .page-number`).val();
        if (page === '') page = 1;
        let speicalObjects = models[modelName].specialObjects ?? null;
        let data = { filters: filters, sort: sort, page: page, speical_objects: speicalObjects };
        console.log(data)
        $.ajax({
            url: '/data_manager/table/' + modelName,
            method: 'POST',
            data: JSON.stringify(data),
            headers: {
                'X-CSRFToken': csrfToken
            },
            success: function (data) {
                modelTable.find('tbody').html(data.html);
                modelTable.find('tbody tr').click(viewItemModal);

                $(`.${modelName}-records-index .min-record`).text(data.min_record);
                $(`.${modelName}-records-index .max-record`).text(data.max_record);
                $(`.${modelName}-records-index .total-records`).text(data.total_records);

                $(`.${modelName}-pages .min-page`).text('1');
                $(`.${modelName}-pages .max-page`).text(data.max_page);
                $(`.${modelName}-pages .page-number`).val(data.page_number);
                setTimeout(() => {
                    runOptionalFunction(`${modelName}sAfterGetTable`);
                }, 100);

            }
        });

    }


    function runOptionalFunction(functionName) {
        const func = window[functionName];
        if (typeof func === "function") {
            const result = func();
            if (result instanceof Promise) {
                return result;
            }
            return Promise.resolve(result);
        }
        return Promise.resolve(null);
    }

    function getSortOfModel(modelName) {
        let modelTable = $('table[data-model-name="' + modelName + '"]');

        let sortColumn = modelTable.find('.column-sort .sort-icon').filter(function () {
            return $(this).attr('data-sort') !== 'none';
        });

        if (sortColumn.length === 0) {
            return null;
        }
        sortColumn = sortColumn.first();
        let sort = sortColumn.attr('data-sort');
        let columnName = sortColumn.closest('th').data('column');
        let order = '';
        if (sort === 'desc') order = '-';
        return order + columnName;
    }

    function getFiltersOfModel(modelName) {
        filters = {}
        $(`.${modelName}-filter`).each(function () {
            let element = $(this);
            let fieldName = element.data("field-name");
            let value = null;

            if (element.is("input, select")) {
                if (element.is(":radio, :checkbox")) {
                    if (element.is(":checked")) {
                        value = element.val();
                    }
                } else {
                    value = element.val();
                }
            }
            else if (element.hasClass("btn-group")) {
                value = element.find("input[type='radio']:checked").val() || "";
            }

            if (element.hasClass("process-value")) {
                functionName = element.data("process-value");
                value = window[functionName](value);
            }

            if (value !== "" && value !== "0") {
                filters[fieldName] = value;
            }
        });

        return filters;
    }

    function viewItemModal(e = null, modelName = null, itemId = '', modalSize = 'md') {
        let btn;
      
        return new Promise(async (resolve) => {
            if (e !== null) {

                btn = $(e.currentTarget);
                modelName = btn.data("model-name");
                itemId = btn.data("id");
                modalSize = btn.data("modal-size");
            }
            return;
            await loadContent(`#${modalSize}_modal_content`, `/data_manager/item/${modelName}/${itemId}`);
            $("#modal-" + modalSize).modal("show").data('model-name', modelName);

            resolve();

        });
    }

</script>

</html>