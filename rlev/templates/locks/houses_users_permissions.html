<div class="modal-header d-flex justify-content-between align-items-center">
    <h5 class="modal-title">ניהול הרשאות משתמשים</h5>
</div>
<div class="modal-body" style="max-height: 50vh;
            height: 50vh;
            overflow-y: auto">
    <table class="table table-striped table-hover table-sm border cursor-pointer">
        <tbody>
            {% for user in users %}
            <tr class="child" data-child-id="{{ user.id }}">
                <td>
                    <div class="d-flex justify-content-between">
                        <div class="col-4">{{ user.description }}</div>
                        <div class="col-3">
                            <span class="badge rounded-pill text-dark count-houses">{{ user.count_houses }}</span>
                        </div>
                        <div class="col-4 justify-content-end add-houses-btn"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">סגור</button>
</div>
<script>
    var csrfToken = "{{ csrf_token }}";
    $(document).ready(function () {
        $('.child').click(show_child_houses);
        $('[data-toggle="tooltip"]').tooltip();
    });

    function get_child_houses(user_id, callback) {
        $.ajax({
            url: 'get_houses_users_permissions/' + user_id,
            method: 'GET',
            success: function (data) {
                callback(data);
            },
            error: function (xhr, textStatus, errorThrown) {
                if (xhr.status === 401) {
                    window.location.href = '/login';
                }
            }
        });
    }

    function show_child_houses() {
        if ($(this).hasClass('table-primary')) {
            $(this).removeClass('table-primary');
            $('#houses_list_container').remove();
            $('.add-houses-btn').html('');
            return;
        }
        $(this).siblings().removeClass('table-primary');
        $(this).addClass('table-primary');
        let child_id = $(this).data('child-id');

        $('.add-houses-btn').html('');
        $('#houses_list_container').remove();

        let houses_list_container = $('<div>').addClass('border rounded m-1 p-1').attr('id', 'houses_list_container').css({
            'max-width': '100%',
            'height': '20vh',
            'overflow-y': 'auto',
            'overflow-x': 'auto'
        });

        let houses_list = $("<div>").addClass("d-flex flex-wrap justify-content-start align-items-start").attr("id", "houses_list")
        houses_list_container.append(houses_list);

        $(this).after(houses_list_container);

        let add_houses_btn = $('<span>').addClass('badge rounded-pill bg-primary').css(
            'cursor', 'pointer',
            'font-size', 'small'
        ).html('<i class="bi bi-plus-circle"></i> הוסף דירות').data('child-id', child_id).click(add_houses_to_child);

        $(this).find('.add-houses-btn').html(add_houses_btn);

        get_child_houses(child_id, function (data) {
            load_child_houses(data);
        });
    }

    function load_child_houses(data) {
        $('.table-primary').find('.count-houses').text(data.count_houses);

        let houses = data.houses;
        $('#houses_list').empty();
        houses.forEach(lock => {
            let lockItem = $('<div>').addClass('d-flex justify-content-between align-items-center bg-secondary rounded m-1').css(
                'width', 'fit-content'
            );
            let span = $('<span>').addClass('text-white fw-bold mx-1').css('font-size', 'small').text(lock.alias);
            let btn = $('<button>').addClass('btn btn-secondary rounded-end p-0 px-1 lock_link_btn').css('font-size', 'small').text('x').attr('data-id', lock.id).click(remove_house_from_user);
            $(lockItem).append(span).append(btn);
            $('#houses_list').append(lockItem);
        });
    }

    function remove_house_from_user() {
        let house_id = $(this).data('id');
        let user_id = $('.table-primary').data('child-id');
        $.ajax({
            url: 'remove_house_from_user/' + user_id + '/' + house_id,
            method: 'GET',
            success: function (data) {
                load_child_houses(data);
            },
            error: function (xhr, textStatus, errorThrown) {
                if (xhr.status === 401) {
                    window.location.href = '/login';
                }
            }
        });
    }

    async function add_houses_to_child() {
        event.stopPropagation();
        try {
            let selected_houses = await select_houses();
            let houses_ids = selected_houses.houses_ids;
            if (houses_ids.length == 0) {
                return;
            }

            let child_id = $(this).data('child-id');
            $.ajax({
                url: 'add_houses_to_user',
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                contentType: 'application/json',
                data: JSON.stringify({ houses: houses_ids,  user_id: child_id }),
                success: function (data) {
                    load_child_houses(data);
                },
                error: function (xhr, textStatus, errorThrown) {
                    if (xhr.status === 401) {
                        window.location.href = '/login';
                    }
                }
            });
        }
        catch (error) {
            console.error(error);
        }
    }


</script>